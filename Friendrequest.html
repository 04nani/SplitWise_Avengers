<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Friends</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Open Sans', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #121212;
            color: #FFFFFF;
        }
        .container {
            background-color: #1E1E1E;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        h1 {
            text-align: center;
            color: #57BB8A;
        }
        input[type="text"] {
            margin-bottom: 1rem;
            padding: 0.5rem;
            border: 1px solid #3E3E3E;
            border-radius: 4px;
            background-color: #2A2A2A;
            color: #FFFFFF;
            transition: all 0.3s ease;
        }
        input::placeholder {
            color: #AAAAAA;
        }
        input:focus {
            border-color: #57BB8A;
            outline: none;
            box-shadow: 0 0 5px rgba(87, 187, 138, 0.5);
        }
        ul {
            list-style: none;
            padding: 0;
            margin-top: 1rem;
        }
        li {
            background-color: #2A2A2A;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        button.addFriend {
            background-color: #57BB8A;
            color: white;
            border: none;
            padding: 0.3rem 0.5rem;
            cursor: pointer;
        }
        button.addFriend:hover {
            background-color: #399D6C;
        }
        .message {
            margin-top: 1rem;
            text-align: center;
            opacity: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Add Friends</h1>
        <input type="text" id="friendSearch" placeholder="Search friends..." oninput="searchFriends()">
        <ul id="searchResults"></ul>
        <div id="notification" class="message"></div>

        <!-- Existing friends list -->
        <h2>Your Friends</h2>
        <ul id="friendList"></ul>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/appwrite@11.0.0"></script>
    <script>
        // Initialize Appwrite client
// Initialize Appwrite client
const client = new Appwrite.Client()
    .setEndpoint('https://cloud.appwrite.io/v1')
    .setProject('66f9c641001dbbd4bb66'); 

const databases = new Appwrite.Databases(client);
const account = new Appwrite.Account(client);

const DATABASE_ID = '66f9e43e00253528c7a8'; 
const USERS_COLLECTION_ID = '66f9e45d002562334094'; 
const FRIENDS_COLLECTION_ID = '66fc597e0027848acf57'; 

// Function to search friends
async function searchFriends() {
    const query = document.getElementById('friendSearch').value;
    if (!query) {
        document.getElementById('searchResults').innerHTML = '';
        return;
    }

    try {
        const currentUser = await account.get(); // Get current logged-in user
        
        // Fetch friends to exclude them from search results
        const friends = await databases.listDocuments(DATABASE_ID, FRIENDS_COLLECTION_ID, [
            Appwrite.Query.equal('accountId', currentUser.$id)
        ]);
        const friendIds = friends.documents.map(friend => friend.friendId);

        // Query the Users collection for matching friends, exclude current user and already added friends
        const results = await databases.listDocuments(DATABASE_ID, USERS_COLLECTION_ID, [
            Appwrite.Query.search('name', query),
            Appwrite.Query.notEqual('accountId', currentUser.$id),   // Exclude current user
            ...friendIds.map(id => Appwrite.Query.notEqual('accountId', id)) // Exclude already added friends
        ]);

        displaySearchResults(results.documents);
    } catch (error) {
        console.error('Error fetching search results:', error);
    }
}

// Display search results
function displaySearchResults(users) {
    const resultsList = document.getElementById('searchResults');
    resultsList.innerHTML = '';

    users.forEach(user => {
        const li = document.createElement('li');
        li.textContent = user.name;

        const addButton = document.createElement('button');
        addButton.textContent = 'Add Friend';
        addButton.classList.add('addFriend');
        addButton.onclick = () => sendFriendRequest(user.accountId); // Use accountId

        li.appendChild(addButton);
        resultsList.appendChild(li);
    });
}

// Send friend request
async function sendFriendRequest(friendId) {
    try {
        const currentUser = await account.get();
        const data = {
            accountId: currentUser.$id,
            friendId: friendId,
            status: 'pending'
        };

        // Use Appwrite.ID.unique() to generate a unique ID for the document
        await databases.createDocument(DATABASE_ID, FRIENDS_COLLECTION_ID, Appwrite.ID.unique(), data);
        alert('Friend request sent');
    } catch (error) {
        console.error('Error sending friend request:', error);
    }
}

// Fetch and display existing friends
async function fetchFriends() {
    try {
        const currentUser = await account.get();
        const friends = await databases.listDocuments(DATABASE_ID, FRIENDS_COLLECTION_ID, [
            Appwrite.Query.equal('accountId', currentUser.$id),
            Appwrite.Query.equal('status', 'accepted')
        ]);

        displayFriends(friends.documents);
    } catch (error) {
        console.error('Error fetching friends:', error);
    }
}

function displayFriends(friends) {
    const friendList = document.getElementById('friendList');
    friendList.innerHTML = '';

    friends.forEach(friend => {
        const li = document.createElement('li');
        li.textContent = friend.friendId; // You may want to fetch the friend's name from USERS_COLLECTION_ID
        friendList.appendChild(li);
    });
}

window.onload = () => {
    fetchFriends(); // Fetch friends on page load
};

    </script>
</body>
</html>
